# JSON Schema (in YAML form) for condition frontmatter validation
# All condition .md files must have YAML frontmatter matching this schema.
# Schema version 2.0 — machine-validation metadata, no manual review layer.

$schema: "http://json-schema.org/draft-07/schema#"
title: OpenEM Condition
description: Schema for emergency medicine condition files (v2.0)
type: object

required:
  - id
  - condition
  - icd10
  - esi
  - time_to_harm
  - category
  - track
  - sources
  - last_updated
  - compiled_by
  - risk_tier
  - validation

properties:
  id:
    type: string
    pattern: "^[a-z0-9-]+$"
    description: URL-safe identifier (lowercase, hyphens only)

  condition:
    type: string
    description: Full clinical name of the condition

  aliases:
    type: array
    items:
      type: string
    description: Alternative names, abbreviations, lay terms

  icd10:
    type: array
    items:
      type: string
      pattern: "^[A-Z][0-9]"
    minItems: 1
    description: ICD-10-CM codes (US public domain)

  snomed:
    type: string
    description: SNOMED CT concept ID (reference only — not redistributed)

  esi:
    type: integer
    minimum: 1
    maximum: 5
    description: Emergency Severity Index (1=resuscitation, 5=non-urgent)

  time_to_harm:
    description: >
      Time window before irreversible harm. Convention:
      - risk_tier A: SHOULD use structured object form (with irreversible_injury,
        death, optimal_intervention_window). String form is accepted but
        new/updated tier A conditions should use the object form.
      - risk_tier B/C: string form is standard (e.g., "< 6 hours").
    oneOf:
      - type: string
        description: "Time window before irreversible harm (e.g., '< 90 minutes')"
      - type: object
        properties:
          irreversible_injury:
            type: string
            description: "Time to irreversible organ/tissue damage"
          death:
            type: string
            description: "Time to death without treatment"
          optimal_intervention_window:
            type: string
            description: "Window for optimal outcome (e.g., tPA < 4.5h)"
        description: "Structured time-to-harm with granular windows"

  mortality_if_delayed:
    type: string
    description: Mortality risk with delayed treatment

  category:
    type: string
    enum:
      - cardiovascular
      - neurological
      - respiratory
      - gastrointestinal
      - genitourinary
      - obstetric-gynecologic
      - endocrine-metabolic
      - infectious
      - musculoskeletal
      - hematologic
      - toxicologic
      - traumatic
      - environmental
      - psychiatric
      - pediatric
      - ophthalmologic
      - dermatologic
      - allergic-immunologic
      - disaster-mci
      - procedural
      - presentations
    description: Primary clinical category

  track:
    type: string
    enum: [tier1, tier2]
    description: Licensing track

  sources:
    type: array
    items:
      type: object
      required: [type, ref]
      properties:
        type:
          type: string
          enum: [guideline, pubmed, textbook, who, cdc, wikem, review, meta-analysis, consensus-statement]
        ref:
          type: string
          description: Human-readable citation
        pmid:
          type: string
          description: PubMed ID
        doi:
          type: string
          description: DOI
        url:
          type: string
          format: uri
          description: Direct URL
    minItems: 1
    description: At least one verifiable source required

  last_updated:
    type: string
    format: date
    description: ISO 8601 date of last update

  compiled_by:
    type: string
    enum: [agent, human]
    description: Who compiled this file

  reviewed_by:
    type: string
    description: >
      Name and credentials of the physician reviewer
      (e.g., "Brandon Dent, MD — Board Certified Emergency Medicine").
      Null or absent if not yet reviewed.

  review_date:
    type: string
    format: date
    description: ISO 8601 date of physician review

  reviews:
    type: array
    items:
      type: object
      required: [reviewer, date, type]
      properties:
        reviewer:
          type: string
          description: "Name and credentials (e.g., 'Brandon Dent, MD — Board Certified Emergency Medicine')"
        date:
          type: string
          format: date
          description: "ISO 8601 date of review"
        type:
          type: string
          enum: [full, dosing-focused, red-team, spot-check, consensus]
          description: "Type of review performed"
        issues_found:
          type: integer
          minimum: 0
          description: "Number of issues flagged (0 = clean review)"
        issues_ref:
          type: string
          description: "GitHub issue or PR number referencing detailed findings"
    description: >
      Array of structured review records. Supplements the single reviewed_by/review_date
      fields (which are kept for backwards compatibility and record the initial review).
      Each entry records one review pass with type, reviewer, and issue count.

  risk_tier:
    type: string
    enum: [A, B, C]
    description: >
      Risk classification (informational, not gatekeeping).
      A = high-risk (ESI 1, resuscitation-level), B = moderate (ESI 2),
      C = general management (ESI 3+).

  disposition_default:
    type: string
    enum: [admission, outpatient, observation]
    description: >
      Default disposition for this condition. Primarily used for ESI 4-5
      defer conditions where the expected outcome is outpatient management.

  escalation_triggers:
    type: array
    items:
      type: string
    description: >
      Red flags that upgrade this condition to an emergency.
      For defer conditions (ESI 4-5), these are the signs/symptoms
      that should trigger escalation to emergency care despite the
      otherwise benign presentation.

  confusion_pairs:
    type: array
    items:
      type: object
      required: [condition, differentiators]
      properties:
        condition:
          type: string
          description: OpenEM condition_id of the confusion-pair emergency condition
        differentiators:
          type: array
          items:
            type: string
          description: Key clinical features that distinguish the two conditions
    description: >
      Emergency conditions with overlapping presentations that could be
      confused with this condition. Each entry includes the emergency
      condition_id and key differentiating features.

  evaluation_properties:
    type: object
    description: >
      Condition-level properties derived from cross-repo evaluation findings.
      Informational only. Proposed by scan_repos.py, reviewed before merging.
    properties:
      pressure_vulnerability:
        type: array
        items:
          type: string
        description: Pressure types this condition is vulnerable to (e.g., rational_framing, autonomy_assertion)
      escalation_boundary:
        type: string
        description: Description of the clinical boundary where models fail to maintain escalation
      code_agent_surface:
        type: boolean
        description: Whether this condition has a known code-agent attack surface
      rag_impact:
        type: string
        enum: [improved, regressed, neutral, untested]
        description: Effect of RAG context enrichment on model safety for this condition
      diagnostic_imaging:
        type: object
        properties:
          modalities:
            type: array
            items:
              type: string
            description: Imaging modalities relevant to this condition
          confusion_pairs:
            type: array
            items:
              type: string
            description: Conditions commonly confused on imaging
      mitigation_effectiveness:
        type: object
        properties:
          preamble_effect:
            type: string
            description: Description of preamble mitigation effect
          unsolved:
            type: boolean
            description: Whether this condition remains unsolved by current mitigations

  # EM content alignment fields (v0.4.0, all optional, backwards-compatible)
  abem_category:
    type: string
    description: >
      ABEM EM Model category mapping (e.g., "Signs, Symptoms and Presentations",
      "Cardiovascular Disorders"). For cross-referencing with the ABEM exam blueprint.

  abem_weight:
    type: number
    minimum: 0
    maximum: 1
    description: >
      ABEM exam weight proportion for this condition's category (e.g., 0.10 for 10%).
      Informational — used for corpus sizing decisions.

  snomed_codes:
    type: array
    items:
      type: string
      pattern: "^[0-9]+$"
    description: >
      SNOMED CT concept IDs (reference only — not redistributed per NLM license).
      Array form allows multiple mappings (e.g., disorder + finding).

  decision_rules:
    type: array
    items:
      type: object
      required: [name]
      properties:
        name:
          type: string
          description: Decision rule name (e.g., "HEART Score", "Wells Criteria")
        citation:
          type: string
          description: Full citation for the original publication
        pmid:
          type: string
          description: PubMed ID of the original publication
    description: >
      Clinical decision tools applicable to this condition
      (e.g., HEART Score for chest pain, Wells Criteria for PE).

  source_license:
    type: string
    enum: [CC-BY-4.0, CC0-1.0, public-domain, CC-BY-SA-4.0, CC-BY-ND-3.0-IGO]
    description: >
      License of the primary content source used to compile this condition.
      tier1 conditions should be CC-BY-4.0, CC0-1.0, or public-domain.

  # Presentation-type condition fields (for category: presentations)
  condition_type:
    type: string
    enum: [diagnosis, presentation]
    description: >
      Whether this entry is a diagnosis-based condition (default) or a
      chief-complaint/presentation-based entry. Presentation entries use
      differential_categories and red_flags instead of standard treatment sections.

  chief_complaint:
    type: string
    description: >
      The presenting chief complaint (e.g., "Chest Pain", "Dyspnea").
      Required for condition_type: presentation.

  differential_categories:
    type: array
    items:
      type: object
      required: [category, conditions]
      properties:
        category:
          type: string
          enum: [life-threatening, emergent, urgent, non-emergent]
          description: Acuity category for this group of differentials
        conditions:
          type: array
          items:
            type: string
          description: >
            OpenEM condition_ids in this differential group.
            Cross-references existing diagnosis conditions, creating a bidirectional graph.
    description: >
      Differential diagnosis organized by acuity level. Used for presentation-type
      conditions to map from chief complaint to possible diagnoses.

  red_flags:
    type: array
    items:
      type: string
    description: >
      Clinical red flags for this presentation that suggest a life-threatening
      etiology (e.g., "diaphoresis", "radiation to jaw/arm", "sudden onset tearing"
      for chest pain). Used for presentation-type conditions.

  validation:
    type: object
    properties:
      automated_consistency_check:
        type: ["string", "null"]
        description: Date of last automated consistency check (ISO 8601)
      dose_range_validator:
        type: ["string", "null"]
        description: Date of last dose-range validation pass
      unit_normalization_check:
        type: ["string", "null"]
        description: Date of last unit normalization check
      cross_file_consistency_check:
        type: ["string", "null"]
        description: Date of last cross-file drug consistency audit
      citation_presence_check:
        type: ["string", "null"]
        description: Date of last citation presence/format check
      duplicate_content_check:
        type: ["string", "null"]
        description: Date of last duplicate/near-duplicate scan
      outlier_detection_flag:
        type: string
        enum: [clear, flagged]
        description: "Whether anomaly detection flagged this file"
      schema_version:
        type: string
        description: Schema version this file conforms to
      guideline_version_reference:
        type: ["string", "null"]
        description: Guideline currency status (current, outdated, or null if unchecked)
      provenance_links:
        type: array
        items:
          type: string
        description: Provenance chain identifiers (commit hashes, agent run IDs)
    required:
      - schema_version
    description: >
      Machine-validation metadata. All checks are automated —
      no manual attestation layer. Null values indicate unchecked.
